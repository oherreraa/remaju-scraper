name: REMAJU Scraper - Estructura Modular

on:
  # Trigger manual desde GitHub
  workflow_dispatch:
    inputs:
      trigger_source:
        description: 'Fuente del trigger (manual, n8n_automated, etc.)'
        required: false
        default: 'manual'
        type: string
      max_pages:
        description: 'MÃ¡ximo nÃºmero de pÃ¡ginas a procesar (0 = sin lÃ­mite)'
        required: false
        default: '10'
        type: string
      max_details:
        description: 'MÃ¡ximo nÃºmero de remates para extraer detalle completo'
        required: false
        default: '5' 
        type: string
      headless:
        description: 'Ejecutar en modo headless'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

  # Trigger programado (comentado por defecto)
  # schedule:
  #   - cron: '0 5 * * 1-5'  # Lunes a viernes 5 AM UTC

  # Trigger desde API (usado por n8n)
  repository_dispatch:
    types: [remaju_scrape]

jobs:
  scrape-remaju:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸŒ Setup Chrome Browser
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: 'stable'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ”§ Configure environment
      run: |
        echo "PYTHONUNBUFFERED=1" >> $GITHUB_ENV
        echo "MAX_PAGES=${{ inputs.max_pages || '10' }}" >> $GITHUB_ENV
        echo "MAX_DETAILS=${{ inputs.max_details || '5' }}" >> $GITHUB_ENV
        echo "HEADLESS=${{ inputs.headless || 'true' }}" >> $GITHUB_ENV
        echo "TRIGGER_SOURCE=${{ inputs.trigger_source || github.event.action || 'workflow_dispatch' }}" >> $GITHUB_ENV
        echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV
        
    - name: ðŸ“Š Display configuration
      run: |
        echo "ðŸ”§ ConfiguraciÃ³n de ejecuciÃ³n:"
        echo "  â€¢ Fuente: ${{ env.TRIGGER_SOURCE }}"
        echo "  â€¢ PÃ¡ginas mÃ¡x: ${{ env.MAX_PAGES }}"
        echo "  â€¢ Detalles mÃ¡x: ${{ env.MAX_DETAILS }}"
        echo "  â€¢ Headless: ${{ env.HEADLESS }}"
        echo "  â€¢ Runner: ${{ runner.os }}"
        
    - name: ðŸš€ Run REMAJU scraper
      id: scraper
      run: |
        echo "ðŸŽ¯ Iniciando scraper REMAJU con estructura modular..."
        echo "ðŸ“ MÃ³dulos: Remates (listado) + Detalle (3 tabs)"
        python remaju_scraper_updated.py
        echo "âœ… Scraping completado"
        
    - name: ðŸ“‹ Process results 
      if: always()
      run: |
        if [ -f remates_result.json ]; then
          echo "ðŸ“Š AnÃ¡lisis de resultados:"
          python -c "
          import json
          import sys
          
          try:
              with open('remates_result.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              status = data.get('status', 'unknown')
              print(f'Status: {status}')
              
              if status == 'success':
                  stats = data.get('estadisticas', {})
                  modulo_remates = data.get('modulo_remates', {})
                  modulo_detalle = data.get('modulo_detalle_remates', [])
                  
                  print(f'ðŸ“ˆ EstadÃ­sticas:')
                  print(f'  â€¢ Total remates (listado): {stats.get(\"total_remates_listado\", 0)}')
                  print(f'  â€¢ Remates con detalle: {stats.get(\"remates_con_detalle\", 0)}')
                  print(f'  â€¢ PÃ¡ginas procesadas: {stats.get(\"paginas_procesadas\", 0)}')
                  print(f'  â€¢ DuraciÃ³n: {stats.get(\"duracion_segundos\", 0)} segundos')
                  print(f'  â€¢ Tasa Ã©xito detalle: {stats.get(\"tasa_exito_detalle\", 0)}%')
                  
                  print(f'ðŸ›ï¸ MÃ³dulo Remates:')
                  print(f'  â€¢ Filtros aplicados: {len(modulo_remates.get(\"filtros_aplicados\", {}))} filtros')
                  print(f'  â€¢ Elementos formulario: {len(modulo_remates.get(\"formulario_filtros\", {}))} campos')
                  print(f'  â€¢ Resultados encontrados: {len(modulo_remates.get(\"resultados\", []))} remates')
                  
                  print(f'ðŸ” MÃ³dulo Detalle:')
                  print(f'  â€¢ Remates con detalle completo: {len(modulo_detalle)} remates')
                  
                  if modulo_detalle:
                      primer_detalle = modulo_detalle[0].get('detalle', {})
                      tab_remate = primer_detalle.get('tab_remate', {})
                      tab_inmuebles = primer_detalle.get('tab_inmuebles', [])
                      tab_cronograma = primer_detalle.get('tab_cronograma', [])
                      
                      print(f'  â€¢ Tab Remate: {\"SÃ­\" if tab_remate else \"No\"} (expediente + econÃ³mico)')
                      print(f'  â€¢ Tab Inmuebles: {len(tab_inmuebles)} bienes')
                      print(f'  â€¢ Tab Cronograma: {len(tab_cronograma)} eventos')
              
              elif status == 'error':
                  print(f'âŒ Error: {data.get(\"error_message\", \"Error desconocido\")}')
                  sys.exit(1)
              
              else:
                  print(f'âš ï¸ Estado desconocido: {status}')
                  sys.exit(1)
                  
          except Exception as e:
              print(f'âŒ Error procesando resultados: {e}')
              sys.exit(1)
          "
        else
          echo "âŒ No se encontrÃ³ archivo de resultados"
          exit 1
        fi
        
    - name: ðŸ’¾ Upload results artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: remaju-results-${{ github.run_number }}-${{ github.run_attempt }}
        path: |
          remates_result.json
          remaju_scraper.log
        retention-days: 30
        compression-level: 6
        
    - name: ðŸ“¤ Upload to releases (on success)
      if: success() && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: data-${{ github.run_number }}
        name: "REMAJU Data - ${{ github.run_number }}"
        body: |
          ðŸŽ¯ **ExtracciÃ³n REMAJU Completa**
          
          ðŸ“… **Fecha:** ${{ steps.scraper.outputs.timestamp || github.event.head_commit.timestamp }}
          ðŸ”— **Fuente:** https://remaju.pj.gob.pe
          ðŸ“Š **Run:** #${{ github.run_number }}
          
          ### Estructura de Datos:
          - **MÃ³dulo Remates:** Listado con filtros y resultados
          - **MÃ³dulo Detalle:** InformaciÃ³n completa por remate
            - Tab "Remate": Datos generales (expediente + econÃ³mico) 
            - Tab "Inmuebles": Lista de bienes
            - Tab "Cronograma": Eventos del remate
          
          ### ConfiguraciÃ³n:
          - PÃ¡ginas mÃ¡x: ${{ env.MAX_PAGES }}
          - Detalles mÃ¡x: ${{ env.MAX_DETAILS }}
          - Trigger: ${{ env.TRIGGER_SOURCE }}
        files: |
          remates_result.json
        draft: false
        prerelease: false
        
    - name: ðŸ“ Create summary
      if: always()
      run: |
        echo "## ðŸŽ¯ REMAJU Scraper - Resumen" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f remates_result.json ]; then
          python -c "
          import json
          import os
          
          with open('remates_result.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          status = data.get('status', 'unknown')
          
          if status == 'success':
              stats = data.get('estadisticas', {})
              
              summary = f'''### âœ… EjecuciÃ³n Exitosa
              
              **EstadÃ­sticas:**
              - ðŸ“Š Total remates: {stats.get('total_remates_listado', 0)}
              - ðŸ” Con detalle: {stats.get('remates_con_detalle', 0)}
              - ðŸ“„ PÃ¡ginas: {stats.get('paginas_procesadas', 0)}
              - â±ï¸ DuraciÃ³n: {stats.get('duracion_segundos', 0)} seg
              - ðŸ“ˆ Tasa Ã©xito: {stats.get('tasa_exito_detalle', 0)}%
              
              **Estructura Modular:**
              - ðŸ›ï¸ MÃ³dulo Remates: Listado + filtros
              - ðŸ” MÃ³dulo Detalle: 3 tabs por remate
              
              '''
              
          else:
              summary = f'''### âŒ EjecuciÃ³n Fallida
              
              **Error:** {data.get('error_message', 'Desconocido')}
              '''
          
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write(summary)
          "
        else
          echo "### âŒ Sin resultados" >> $GITHUB_STEP_SUMMARY
          echo "No se generÃ³ archivo de resultados" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        # Limpiar archivos temporales si existen
        rm -f chromedriver.log
        echo "âœ… Cleanup completado"
